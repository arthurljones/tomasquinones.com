<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RWGPS: New Monthly Goal Chart Proof of Concept</title>
    <link rel="stylesheet" href="rwgps-style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id='authentication-bar'>
        <div id='sign-in'><a href=''>Sign In</a>
            <form action='javascript:' onsubmit='fetchData()' method='post' class='sign-in-form'>
                <input type='text' name='email' id='emailForm' placeholder='email' />
                <input type='password' name='password' id='passwordForm' placeholder='password' />
                <button type='submit'>submit</button>
            </form>
        </div>
        <div id='sign-out'><a onclick='signOut()' href=''>Sign Out</a></div>
    </div>

    <div id='goals-container'>
        <div id='goals-list'></div>
    </div>

    <div id='content-container'>
        <div class="titleBar">
            <div>
                <h1 id="goal-title"></h1>
            </div>
        </div>

        <div class="card line-chart">
            <canvas id="goal-chart"></canvas>
        </div>

        <div id='progress-card' class='card'>
            <div id='progress-bar-container'>
                <div id='progress-bar-inner'>
                    Progress
                </div>
            </div>
        </div>

        <div class="goal-details-container">
            <div class="goal-details-text card">
                <div id='goal-image'></div>
                <div>Start: June 1, 2022</div>
                <div>End: June 30, 2022</div>
                <div>You will need to ride an average of <span id="average-needed"></span> miles per day to complete
                    this
                    goal.</div>
                <div>You have completed <span id="goal-percent"></span>% of this goal.</div>
                <div class='goal-completed'>You finished this goal by riding a total of <span
                        id='total-distance'></span>
                    miles!</div>
                <div>While activities marked 'private' are shown in your ride list for the goal, only you will be able
                    to
                    view their details and not viewable by other participants.</div>

                <div id='original-goal'></div>
            </div>

            <div class="pie-chart card">
                <h2>Gear by Distance:</h2>

                <!-- <ul class=" gearList">
                </ul> -->
                <canvas id='gear-distances-chart'></canvas>
            </div>
            <div class="pie-chart card">
                <h2>Gear by Trips:</h2>
                <!-- <ul class=" gearList">
                </ul> -->
                <canvas id='gear-rides-chart'></canvas>
            </div>
        </div>

        <div class="leader-board card">
            <h2>TODO: Leader Board</h2>
            <div class="participant-card">Participant 1</div>
            <div class="participant-card">Participant 2</div>
            <div class="participant-card">Participant 3</div>
        </div>


        <div class="rides-list-container card">
            <h2>Rides:</h2>
            <ul class="rideList">
            </ul>
        </div>

        <div class='comment-card card'>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('auth_token');
        const contentContainer = document.getElementById('content-container');

        if (authToken) {
            fetchData();
        } else {
            contentContainer.style.display = 'none';
        }

        function signOut() {
            localStorage.clear();
            document.getElementById('content-container').style.display = 'none';
            document.getElementById('sign-in').style.display = 'block';
        }



        function requestData(url, authToken) {
            const authHeaders = new Headers();
            if (authToken) { authHeaders.append('x-rwgps-auth-token', authToken) };
            authHeaders.append('x-rwgps-api-key', 'aa49d17b');
            authHeaders.append('x-rwgps-api-version', '3');

            const request = new Request(url, {
                headers: authHeaders
            });
            return fetch(request)
                .then((response) => response.json())

        }



        function calculateTotalDistance(rideList) {
            let dayDistance = 0;
            for (const ride of rideList) {
                const rideDistance = (ride.distance * 0.000621371).toFixed(2);
                dayDistance += Number(rideDistance);
            }
            return dayDistance;
        }



        function getGoalInfo(goalId, userData) {
            const participantRequest = requestData(`https://ridewithgps.com/goals/${goalId}/participants.json`, authToken)
            const goalRequest = requestData(`https://ridewithgps.com/goals/${goalId}.json`, authToken)
            Promise.all([participantRequest, goalRequest])
                .then((combinedData) => {
                    const [participantsData, goalData] = combinedData;
                    document.getElementById('goal-title').textContent = goalData.goal.name;
                    console.log({ 'Goal Data': goalData });
                    console.log({ 'Participant Data': participantsData });
                    const participant = participantsData.results.find((participant) => participant.user.id == userData.user.id)
                    console.log({ participant: participant });

                    requestData(`https://ridewithgps.com/goal_participants/${participant.id}/trips.json?limit=10000&offset=0`, authToken)
                        .then((trips) => {
                            const filteredTrips = trips.results.filter((trip) => !trip.is_excluded);
                            console.log({ trips: trips });
                            renderGoalChart(filteredTrips, goalData.goal);
                            renderGearCharts(filteredTrips, userData);
                            renderRideList(filteredTrips);

                        })
                })
        }


        function metersToMiles(meters) {
            return meters * 0.000621371
        }

        function renderGoalChart(rides, goal) {
            const goalDistance = metersToMiles(goal.goal_params.target_amount); //TODO Convert to Miles
            const goalTarget = goalDistance; //TODO Convert to miles

            const goalStart = goal.starts_on;
            const goalEnd = goal.ends_on;
            const goalStartDate = Date.parse(goalStart);

            function calculateDays(rideDate) {
                days = Math.floor((rideDate - goalStartDate) / (24 * 60 * 60 * 1000));
                return days;
            }

            const goalDayCount = calculateDays(Date.parse(goalEnd)) + 1;
            console.log('goal day count', goalDayCount);

            // Goal Line Generator
            let goalLine = [];
            for (let g = 0; g < goalDayCount; g++) { goalLine.push(goalDistance); }

            // Goal Track Generator
            let stayOnTrack = [];
            for (let i = 8; i < goalDistance; i = i + (goalDistance / goalDayCount)) {
                stayOnTrack.push(i);
            }

            // Days of Month X-axis
            let daysOfMonth = [];
            for (let d = 1; d < goalDayCount; d++) {
                daysOfMonth.push(d);
            }

            let goalDays = [];
            for (let d = 0; d < goalDayCount; d++) {
                goalDays.push([]);
            }

            for (const ride of rides) {
                const rideDepartedAt = Date.parse(ride.departed_at);

                const goalDayIndex = calculateDays(rideDepartedAt);
                const goalDay = goalDays[goalDayIndex];
                if (goalDay) {
                    goalDay.push(ride) // hacky way to fix a problem with invalid indexes
                } else {
                    console.log("trip out of range", goalDayIndex, ride);
                }
            }

            const distancePerDay = goalDays.map(calculateTotalDistance)

            const goalLogo = document.getElementById('goal-image');
            const goalImageThumb = document.createElement('img');
            goalImageThumb.src = goal.icon;
            goalLogo.appendChild(goalImageThumb);

            const originalGoal = document.getElementById('original-goal')
            const originalGoalLink = document.createElement('a');
            originalGoalLink.href = `https://ridewithgps.com/goals/${goal.id}`;
            originalGoalLink.textContent = originalGoalLink.href;
            originalGoal.appendChild(originalGoalLink);

            let sum = 0
            let cumulativeDistances = distancePerDay.map(v => Number((sum += v).toFixed(2)));

            const total_ridden = cumulativeDistances.slice([-1]);

            const goalPercentage = Number((total_ridden / goalTarget * 100).toFixed(1));

            const goal_percent = document.getElementById('goal-percent');
            goal_percent.textContent = goalPercentage.toFixed(1);

            const average_needed = document.getElementById('average-needed');
            average_needed.textContent = (goalTarget / goalDayCount).toFixed(1);

            const progress_bar = document.getElementById('progress-bar-inner');
            progress_bar.style = `width: ${goalPercentage}%`;
            progress_bar.textContent = goalPercentage + "%";

            const total_distance = document.getElementById('total-distance');
            total_distance.textContent = total_ridden;

            const ctx = document.getElementById('goal-chart');
            const mixedChart = new Chart(ctx, {
                data: {
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Daily Distances',
                            data: distancePerDay,
                            backgroundColor: 'blue',
                            borderColor: 'blue',
                            borderWidth: 2,
                            borderRadius: 3,

                        }, {
                            type: 'line',
                            label: '500 mile Goal',
                            data: goalLine,
                            pointRadius: 0,
                            backgroundColor: '#ff4000',
                            borderColor: '#ff4000'
                        }, {
                            type: 'line',
                            label: 'Stay On Track!',
                            data: stayOnTrack,
                            pointRadius: 0,
                            backgroundColor: '#ffd700',
                            borderColor: '#ffd700',
                            pointRadius: 2,
                            hoverBorderWidth: 10,

                        }, {
                            type: 'line',
                            label: 'Cumulative Miles',
                            data: cumulativeDistances,
                            fill: true,
                            pointRadius: 3,
                            hoverBorderWidth: 10,
                            backgroundColor: 'hsl(140, 100%, 30%, 50%)',
                            borderColor: '#006622',
                            pointStyle: 'rectRounded',
                        },

                    ],
                    labels: daysOfMonth
                }
            });
        }



        function renderGearCharts(ridesData, userData) {
            const gearDistanceChart = document.getElementById('gear-distances-chart');
            const gearRidesChart = document.getElementById('gear-rides-chart');

            function makeGearConfig(gearNames, gearDistances) {
                return {
                    type: 'doughnut',
                    data: {
                        labels: gearNames,
                        datasets: [{
                            data: gearDistances,

                        }],
                    },
                    hoverBorderWidth: 10,
                    options: {
                        responsive: true,
                    },
                };
            };

            const gearIdToGearName = {};
            for (const gear of userData.user.gear) {
                gearIdToGearName[gear.id] = gear.name;
            }

            const ridesByGearId = Object.groupBy(ridesData, ride => ride.gear_id)

            // console.log(ridesByGearId);

            let gearNames = [];
            const gearDistances = [];
            const gearTripCounts = [];

            for (const gearId in ridesByGearId) {
                const rides = ridesByGearId[gearId];
                gearTripCounts.push(rides.length);
                const ridesDistance = calculateTotalDistance(rides);
                if (ridesDistance > 0) {
                    gearNames.push(gearIdToGearName[gearId]);
                    gearDistances.push(ridesDistance);
                }
            }
            gearNames = gearNames.map((name) => name ? name : 'None');
            // console.log(gearNames);

            const pieChart = new Chart(gearDistanceChart, makeGearConfig(gearNames, gearDistances));
            const pieChart2 = new Chart(gearRidesChart, makeGearConfig(gearNames, gearTripCounts));
        }


        function renderRideList(ridesData) {

            const rideList = document.querySelector(".rideList");

            for (const ride of ridesData) {
                const rideName = ride.name;
                const rideDistance = (ride.distance * 0.000621371).toFixed(2);

                //add ride to goalDays

                const fragment = document.createDocumentFragment();
                const rideItem = fragment
                    .appendChild(document.createElement("li"))
                rideItem.href = `https://ridewithgps.com/trips/${ride.id}`
                rideItem.textContent = rideName + ", " + rideDistance + " miles, " + (ride.elevation_gain * 3.28084).toFixed() + " feet, on " + ride.departed_at.split('T')[0];
                rideList.appendChild(fragment);
            }

        }



        function renderGoalsList(goalsData, userData) {
            console.log('goalsData', goalsData)
            const filteredGoals = goalsData.filter((goal) => goal.goal_type == 'distance');

            const goalList = document.getElementById('goals-list');

            for (const goal of filteredGoals) {
                const goalListCard = document.createElement('div');
                goalListCard.className = 'goal-list-card card';

                const fragments = document.createDocumentFragment();

                const goalTitle = document.createElement('div');
                const goalImage = document.createElement('div');
                const goalStart = document.createElement('div');
                const goalValue = document.createElement('div');

                goalTitle.className = 'goal-name';
                goalTitle.textContent = goal.name;
                fragments.appendChild(goalTitle);

                goalImage.className = 'goal-image'
                goalImage.style = `background-image: url(${goal.icon})`;
                fragments.appendChild(goalImage);

                goalStart.className = 'goal-start';
                goalStart.textContent = `${goal.starts_on} to ${goal.ends_on}`;
                fragments.appendChild(goalStart);

                goalValue.className = '';
                goalValue.textContent = `Distance ${Math.round(metersToMiles(goal.goal_params.max))} miles`;
                fragments.appendChild(goalValue);

                goalListCard.appendChild(fragments);
                goalList.appendChild(goalListCard);

                goalListCard.onclick = () => {
                    getGoalInfo(goal.id, userData);
                    goalList.style.display = 'none';
                }
            }
        }


        function fetchData() {
            contentContainer.style.display = 'block';
            document.getElementById('sign-in').style.display = 'none';
            let userUrl = null;
            if (!authToken) {
                const email = document.getElementById('emailForm').value;
                const password = document.getElementById('passwordForm').value;
                userUrl = `https://ridewithgps.com/users/current.json?email=${email}&password=${password}`;
            } else {
                userUrl = `https://ridewithgps.com/users/current.json`
            }

            // Start Fetching User Data in Promises
            //fetch(userUrl)
            //    .then((response) => response.json())
            requestData(userUrl, authToken)
                .then((userData) => {
                    localStorage.setItem('auth_token', userData.user.auth_token);
                    authToken = localStorage.getItem('auth_token');

                    //console.log({ user: userData });
                    requestData('https://ridewithgps.com/goals.json', authToken)
                        .then((goalsData) => {
                            renderGoalsList(goalsData.results, userData)
                            console.log('goals data!', goalsData);
                        })
                    // getGoalInfo(userData);

                    // requestData(`https://ridewithgps.com/explore/personal.json?models=trips&sort_by=departed_or_created+DESC&departed_at_max=${goalEnd}&departed_at_min=${goalStart}&trip_fields=id%2Cname%2Cdistance%2Celevation_gain%2Cgear_id%2Cdeparted_at&user_id=${userData.user.id}`, authToken)
                    //     .then((ridesData) => {
                    //         console.log({ 'Rides used during the goal time period': ridesData });

                    //         //renderGearCharts(ridesData, userData);

                    //         // renderGoalChart(ridesData.results.trips);

                    //         //renderRideList(ridesData);
                    //     })


                })
        }

    </script>

</body>

</html>
</head>