<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RWGPS: New Monthly Goal Chart Proof of Concept</title>
    <link rel="stylesheet" href="rwgps-style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="titleBar">
        <div id="goal-title">
            <h1>Ride 500 Miles in June, 2022</h1>
        </div>
    </div>
    <div class="card line-chart">
        <canvas id="goal-chart"></canvas>
    </div>

    <div class="goal-details-container">
        <div class="goal-details-text card">
            <h2>Details</h2>
            <!-- <div>
                <ul id="userInfoList">
                    <li class="userName">Name: </li>
                </ul>
            </div> -->
            <div>Start: June 1, 2022</div>
            <div>End: June 30, 2022</div>
            <div>You will need to ride an average of <span id="average-needed"></span> miles per day to complete this
                goal.</div>
            <div>You have completed <span id="goal-percent"></span>% of this goal.</div>
            <div>While activities marked 'private' are shown in your ride list for the goal, only you will be able to
                view their details and not viewable by other participants.</div>

        </div>

        <div class="pie-chart card">
            <h2>Gear by Distance:</h2>

            <ul class=" gearList">
            </ul>
            <canvas id='gear-distances-chart'></canvas>
        </div>
        <div class="pie-chart card">
            <h2>Gear by Trips:</h2>
            <ul class=" gearList">
            </ul>
            <canvas id='gear-rides-chart'></canvas>
        </div>
    </div>

    <div class="leader-board card">
        <h2>TODO: Leader Board</h2>
        <div class="participant-card">Participant 1</div>
        <div class="participant-card">Participant 2</div>
        <div class="participant-card">Participant 3</div>
    </div>


    <div class="rides-list-container card">
        <h2>Rides:</h2>
        <ul class="rideList">
        </ul>
    </div>


    <script>
        const searchParams = new URLSearchParams(window.location.search);
        let userId = searchParams.get("user_id");
        // let printUserID = document.querySelector(".user_id");

        let email = searchParams.get('email');
        let password = searchParams.get('password');

        if (email == null && password == null) {
            email = window.prompt("email");
            password = window.prompt("password")
        }

        //const userInfoList = document.querySelector("#userInfoList");
        const currentUserRequest = new Request(`https://ridewithgps.com/users/current.json?apikey=aa49d17b&apiversion=3&email=${email}&password=${password}`);

        const goalTarget = 500; //miles in this demo

        console.log(505 / goalTarget * 100);
        let rideDistances = [];

        let gearData = {};


        const goalStart = "2022-06-01T00:00:00-08:00";
        const goalEnd = "2022-07-01T00:00:00-08:00";
        const goalStartDate = Date.parse(goalStart);

        function calculateDays(rideDate) {
            days = Math.floor((rideDate - goalStartDate) / (24 * 60 * 60 * 1000));
            return days;
        }

        let goalDays = [];
        for (let d = 0; d < 30; d++) {
            goalDays.push([]);
        }


        function calculateTotalDistance(rideList) {
            let dayDistance = 0;
            for (const ride of rideList) {
                const rideDistance = (ride[2] * 0.000621371).toFixed(2);
                dayDistance += Number(rideDistance);
            }
            return dayDistance;
        }


        // Gear used on the Goal
        const gearDistanceChart = document.getElementById('gear-distances-chart');
        const gearRidesChart = document.getElementById('gear-rides-chart');

        function makeGearConfig(gearNames, gearDistances) {
            return {
                type: 'doughnut',
                data: {
                    labels: gearNames,
                    datasets: [{
                        data: gearDistances,
                    }],
                },
                hoverBorderWidth: 10,
                options: {
                    responsive: true,
                },
            };
        };



        // Start Fetching User Data in Promises
        fetch(currentUserRequest)
            .then((response) => response.json())
            .then((userData) => {
                console.log(userData);
                //const userName = document.querySelector(".userName");
                //userName.textContent = "Name: " + userData.user.name;
                const gearList = document.querySelector(".gearList");

                const gearIdToGearName = {};
                for (const gear of userData.user.gear) {
                    gearIdToGearName[gear.id] = gear.name;
                }

                const statsRequest = new Request(`https://ridewithgps.com/users/${userData.user.id}/career_stats.json?apikey=aa49d17b&apiversion=3&auth_token=${userData.user.auth_token}&interval=month&interval_value=2022-06`);

                // fetch(statsRequest)
                //     .then((response) => response.json())
                //     .then((statsData) => {
                //         console.log(statsData)  //stats here

                //         const listItemYearlyStats = document.createElement("li");
                //         listItemYearlyStats.textContent = `Distance in June 2022 ${(statsData.distance * 0.000621371).toFixed(2)} miles`; //put meters to miles value in const 0.000621371
                //         userInfoList.appendChild(listItemYearlyStats);
                //     });


                // Where did I get this URL?
                const ridesRequest = new Request(`https://ridewithgps.com/explore/personal.json?models=trips&sort_by=departed_or_created+DESC&departed_at_max=${goalEnd}&departed_at_min=${goalStart}&trip_fields=id%2Cname%2Cdistance%2Celevation_gain%2Cgear_id%2Cdeparted_at&user_id=${userData.user.id}apikey=aa49d17b&apiversion=3&email=${email}&password=${password}`);
                fetch(ridesRequest)
                    .then((response) => response.json())
                    .then((ridesData) => {
                        console.log(ridesData);
                        const rideList = document.querySelector(".rideList");

                        for (const ride of ridesData.results.trips) {
                            const rideName = ride[1];
                            const rideDistance = (ride[2] * 0.000621371).toFixed(2);
                            const rideDepartedAt = Date.parse(ride[5]);
                            rideDistances.unshift(Number(rideDistance));
                            //add ride to goalDays
                            const goalDayIndex = calculateDays(rideDepartedAt);
                            const goalDay = goalDays[goalDayIndex];
                            if (goalDay) {
                                goalDay.push(ride) // hacky way to fix a problem with invalid indexes
                            }


                            const fragment = document.createDocumentFragment();
                            const alink = fragment
                                .appendChild(document.createElement("li"))
                                .appendChild(document.createElement("a"))
                            alink.href = `https://ridewithgps.com/trips/${ride[0]}`
                            //const rideListItem = document.createElement("li").appendChild(document.createElement("a"));
                            // rideListItem.href = `https://ridewithgps.com/trips/${ride[0]}`

                            alink.textContent = rideName + ", " + rideDistance + " miles, " + (ride[3] * 3.28084).toFixed() + " feet, on " + ride[5].split('T')[0];
                            //rideListItem.textContent = rideName + ", " + rideDistance + " miles, " + (ride[3] * 3.28084).toFixed() + " feet " + goalDayIndex;

                            rideList.appendChild(fragment);
                            //rideList.appendChild(rideListItem);


                        }

                        const ridesByGearId = Object.groupBy(ridesData.results.trips, ride => ride[4])
                        console.log(ridesByGearId);


                        const gearNames = [];
                        const gearDistances = [];
                        const gearTripCounts = [];

                        for (const gearId in ridesByGearId) {
                            const rides = ridesByGearId[gearId];
                            gearTripCounts.push(rides.length);
                            const ridesDistance = calculateTotalDistance(rides);
                            if (ridesDistance > 0) {
                                gearNames.push(gearIdToGearName[gearId]);
                                gearDistances.push(ridesDistance);
                            }
                        }
                        console.log(gearTripCounts);



                        const pieChart = new Chart(gearDistanceChart, makeGearConfig(gearNames, gearDistances));
                        const pieChart2 = new Chart(gearRidesChart, makeGearConfig(gearNames, gearTripCounts));

                        const distancePerDay = goalDays.map(calculateTotalDistance)

                        let sum = 0
                        let cumulativeDistances = distancePerDay.map(v => Number((sum += v).toFixed(2)));

                        const goalPercentage = cumulativeDistances.slice([-1]) / goalTarget * 100;
                        const goal_percent = document.getElementById('goal-percent');
                        goal_percent.textContent = goalPercentage.toFixed(1);

                        const average_needed = document.getElementById('average-needed');
                        average_needed.textContent = (goalTarget / 30).toFixed(1);

                        const mixedChart = new Chart(ctx, {
                            data: {
                                datasets: [
                                    {
                                        type: 'bar',
                                        label: 'Daily Distances',
                                        data: distancePerDay,
                                        backgroundColor: 'blue',
                                        borderColor: 'blue',
                                    }, {
                                        type: 'line',
                                        label: '500 mile Goal',
                                        data: goal,
                                        pointRadius: 0,
                                        backgroundColor: '#ff4000',
                                        borderColor: '#ff4000'
                                    }, {
                                        type: 'line',
                                        label: 'Stay On Track!',
                                        data: stayOnTrack,
                                        pointRadius: 0,
                                        backgroundColor: '#ffd700',
                                        borderColor: '#ffd700',

                                    }, {
                                        type: 'line',
                                        label: 'Cumulative Miles',
                                        data: cumulativeDistances,
                                        fill: true,
                                        pointRadius: 5,
                                        hoverBorderWidth: 10,
                                        backgroundColor: 'hsl(140, 100%, 30%, 50%)',
                                        borderColor: '#006622',

                                    },

                                ],
                                labels: daysOfMonth
                            }
                        });

                    })



            }).then(
            // () => { const pieChart = new Chart(GEAR, makeGearConfig([20, 40, 15])); }
        )
            .then(
                () => {
                }
            )


        const ctx = document.getElementById('goal-chart');

        // Goal Line Generator
        let goalDistance = 500;
        let goal = [];
        for (let g = 0; g < 32; g++) {
            goal.push(goalDistance);
        }

        // Goal Track Generator
        let stayOnTrack = [];
        for (let i = 8; i < goalDistance; i = i + (goalDistance / 30)) {
            stayOnTrack.push(i);
        }

        // Days of Month X-axis
        let daysOfMonth = [];
        for (let d = 1; d < 31; d++) {
            daysOfMonth.push(d);
        }







    </script>

</body>

</html>
</head>